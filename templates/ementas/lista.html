{% extends "base.html" %}
{% block title %}Pesquisar Ementas{% endblock %}
{% block content %}
  <h1 class="h3 mb-3">Pesquisar Ementas</h1>
  
  <form method="get" class="mb-4">
    <div class="row g-2 mb-3">
      <div class="col-sm-8 col-md-10">
        <input name="q" value="{{ q }}" class="form-control" placeholder="Busque por tÃ­tulo, nÃºmero, resumo ou ementa">
      </div>
      <div class="col-sm-4 col-md-2 d-grid">
        <button class="btn btn-primary">Buscar</button>
      </div>
    </div>
    
    <div class="row g-3">
      <div class="col-md-3">
        <label for="tipo_ato" class="form-label">Tipo de Ato Normativo</label>
        <select name="tipo_ato" id="tipo_ato" class="form-select">
          <option value="">Todos os tipos</option>
          {% for valor, label in tipos_ato %}
            <option value="{{ valor }}" {% if tipo_ato == valor %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div class="col-md-3">
        <label for="situacao" class="form-label">SituaÃ§Ã£o</label>
        <select name="situacao" id="situacao" class="form-select">
          <option value="">Todas as situaÃ§Ãµes</option>
          {% for valor, label in situacoes %}
            <option value="{{ valor }}" {% if situacao == valor %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div class="col-md-3">
        <label for="data_inicio" class="form-label">Data de InÃ­cio</label>
        <input type="date" name="data_inicio" id="data_inicio" class="form-control" value="{{ data_inicio }}">
      </div>
      
      <div class="col-md-3">
        <label for="data_fim" class="form-label">Data de Fim</label>
        <input type="date" name="data_fim" id="data_fim" class="form-control" value="{{ data_fim }}">
      </div>
    </div>
    
    <div class="row g-3 mt-2">
      <div class="col-md-4">
        <label for="itens_por_pagina" class="form-label">Itens por pÃ¡gina</label>
        <select name="itens_por_pagina" id="itens_por_pagina" class="form-select">
          {% for opcao in opcoes_paginacao %}
            <option value="{{ opcao }}" {% if itens_por_pagina == opcao %}selected{% endif %}>{{ opcao }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    
    <div class="row g-2 mt-3">
      <div class="col-md-6">
        <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
        <a href="{% url 'ementas:lista' %}" class="btn btn-outline-secondary">Limpar Filtros</a>
      </div>
    </div>
  </form>

  {% if page_obj.object_list %}
    <div class="mb-3">
      <small class="text-muted">
        Mostrando {{ page_obj.start_index }}-{{ page_obj.end_index }} de {{ page_obj.paginator.count }} resultado(s)
        {% if q or tipo_ato or situacao or data_inicio or data_fim %}
          <span class="ms-2">(filtros aplicados)</span>
        {% endif %}
      </small>
    </div>
    
    <ul class="list-group">
      {% for e in page_obj.object_list %}
        <li class="list-group-item">
          <div class="d-flex justify-content-between align-items-start">
            <div class="flex-grow-1">
              <a class="fw-semibold" href="{% url 'ementas:detalhe' e.pk %}">
                {% if e.sigiloso %}
                  <span class="text-warning">ðŸ”’ {{ e.titulo }}</span>
                {% else %}
                  {{ e.titulo }}
                {% endif %}
              </a>
              <div class="mt-1">
                {% if e.numero %}<span class="badge bg-secondary me-2">NÂº {{ e.numero }}</span>{% endif %}
                <span class="badge bg-info me-2">{{ e.get_tipo_ato_normativo_display }}</span>
                <span class="badge {% if e.situacao == 'em_vigor' %}bg-success{% elif e.situacao == 'revogada' %}bg-warning{% else %}bg-danger{% endif %}">
                  {{ e.get_situacao_display }}
                </span>
                {% if e.sigiloso %}
                  <span class="badge bg-warning text-dark">ðŸ”’ SIGILOSO</span>
                {% endif %}
              </div>
              {% if e.data_publicacao %}<div class="text-muted mt-1">PublicaÃ§Ã£o: {{ e.data_publicacao|date:"d/m/Y" }}</div>{% endif %}
              
              {% if e.sigiloso %}
                <div class="alert alert-warning mt-2 mb-0 py-2">
                  <small class="text-muted">
                    <i class="bi bi-shield-lock"></i> 
                    Esta ementa Ã© sigilosa e nÃ£o possui conteÃºdo visÃ­vel neste sistema.
                  </small>
                </div>
              {% else %}
                {% if e.ementa %}<p class="mb-0 mt-2">{{ e.ementa|truncatechars:200 }}</p>{% endif %}
                {% if e.resumo and e.resumo != e.ementa %}<p class="mb-0 mt-1 text-muted"><small>{{ e.resumo|truncatechars:160 }}</small></p>{% endif %}
              {% endif %}
            </div>
          </div>
        </li>
      {% endfor %}
    </ul>

    {% if page_obj.paginator.num_pages > 1 %}
      <nav class="mt-4">
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?{% if q %}q={{ q }}&{% endif %}{% if tipo_ato %}tipo_ato={{ tipo_ato }}&{% endif %}{% if situacao %}situacao={{ situacao }}&{% endif %}{% if data_inicio %}data_inicio={{ data_inicio }}&{% endif %}{% if data_fim %}data_fim={{ data_fim }}&{% endif %}{% if itens_por_pagina != 10 %}itens_por_pagina={{ itens_por_pagina }}&{% endif %}page={{ page_obj.previous_page_number }}">Â«</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Â«</span></li>
          {% endif %}

          <li class="page-item disabled">
            <span class="page-link">PÃ¡gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
          </li>

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?{% if q %}q={{ q }}&{% endif %}{% if tipo_ato %}tipo_ato={{ tipo_ato }}&{% endif %}{% if situacao %}situacao={{ situacao }}&{% endif %}{% if data_inicio %}data_inicio={{ data_inicio }}&{% endif %}{% if data_fim %}data_fim={{ data_fim }}&{% endif %}{% if itens_por_pagina != 10 %}itens_por_pagina={{ itens_por_pagina }}&{% endif %}page={{ page_obj.next_page_number }}">Â»</a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">Â»</span></li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}
  {% else %}
    <div class="alert alert-info">
      {% if q or tipo_ato or situacao or data_inicio or data_fim %}
        Nenhuma ementa encontrada com os filtros aplicados. 
        <a href="{% url 'ementas:lista' %}" class="alert-link">Tente limpar os filtros</a>.
      {% else %}
        Nenhuma ementa encontrada.
      {% endif %}
    </div>
  {% endif %}
{% endblock %}